<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Kaldi的编译过程-makefile | 追风的猪</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Kaldi的编译过程-makefile</h1><a id="logo" href="/.">追风的猪</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Kaldi的编译过程-makefile</h1><div class="post-meta">May 17, 2019<span> | </span><span class="category"><a href="/categories/kaldi/">kaldi</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a class="disqus-comment-count" href="/2019/05/17/Kaldi的编译过程-makefile/#vcomment"><span class="valine-comment-count" data-xid="/2019/05/17/Kaldi的编译过程-makefile/"></span><span> 条评论</span></a><div class="post-content"><h2 id="kaldi-的安装"><a href="#kaldi-的安装" class="headerlink" title="kaldi 的安装"></a>kaldi 的安装</h2><p>通过git从github上将kaldi拉下来之后，kald的目录如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPYING  INSTALL  README.md  egs  misc  scripts  src  tools  window</span><br></pre></td></tr></table></figure></p>
<p>kaldi安装需要分别编译两个目录，分别是src和tools目录。<br>安装步骤如下</p>
<ol>
<li>进入tools目录，依次执行<ul>
<li>extras/check_dependencies.sh //检查依赖，根据对应的提示，安装相应的依赖</li>
<li>make  //make可以指定通过-j的选项，指定job数，加快编译速度</li>
</ul>
</li>
<li>进入src目录，依次执行<ul>
<li>./configure –shared</li>
<li>make depend    //以指定通过-j的选项，指定job数</li>
<li>make           //以指定通过-j的选项，指定job数</li>
</ul>
</li>
</ol>
<h2 id="kaldi的编译过程"><a href="#kaldi的编译过程" class="headerlink" title="kaldi的编译过程"></a>kaldi的编译过程</h2><p>这里主要关注src目录下的编译过程，从前面的安装过程可以看到，第一步主要是参数的配置。<br>下面主要关注第二步make depend和第三步make。src目录的编译主要依赖于四个Makefile文件和一个生成的Makefile文件，四个Makefile文件分别是：</p>
<ul>
<li>src/Makefile</li>
<li>src/kaldi.mk</li>
<li>src/${subdir}/Makefile 这里的subdir指的是src下的子目录。</li>
<li>src/makefiles/default_rules.mk  </li>
</ul>
<p>src的目录如下：<br><img src="/2019/05/17/Kaldi的编译过程-makefile/kaldi_src_dir.png"><br>第一个Makefile是执行make命令所使用的Makefile，是整个kaldi程序编译的入口；第二个Makefile则是公共的Makefile，被其他Makefile通过include包含，主要是设置一些编译选项；第三个Makefile则是src子目录下,负责子目录的编译；第四个Makefile位于src/makefiles下，是make的默认规则，是真正执行编译的Makefile。这四个Makefile的关系是，src/Makefile 和src/${subdir}/Makefile都包含src/kaldi.mk, make命令使用src/Makefile, src/Makefile则分别对src的子目录分别执行make，所以src/Makefile调用src/${subdir}/Makefile，src/${subdir}/Makefile则包含src/makefiles/default_rules.mk, 第四个Makefile会生成kaldi的库和可执行文件。<br>从以上的分析可以知道</p>
<ol>
<li>在src目录下执行make, 会编译src下大部分目录（有些目录不会编译）。</li>
<li>在各个子目录下分别执行make， 则只会编译当前子目录下的文件。</li>
</ol>
<p>前面提到src编译还会生成一个Makefile文件，这个Makefile文件为.depend.mk,这个Makefile文件主要是生成各个.o文件的依赖。 每个需要编译的子目录都会生成这样一个Makefile文件。<br>下面解释安装过程中make depend, make这两个命令的作用，make depend执行src/下的Makefile中的depend的目录，其效果就是生成各个需要编译的目录下的.depend.mk文件，之后执行make命令，开始真正编译src目录。</p>
<p>下面对这五个Makefile分别解读。<br>(1)src/Makefile<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This is the top-level Makefile for Kaldi.</span></span><br><span class="line"><span class="comment"># Also see kaldi.mk which supplies options and some rules</span></span><br><span class="line"><span class="comment"># used by the Makefiles in the subdirectories.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Shell</span></span><br><span class="line">SHELL := /bin/bash</span><br><span class="line"><span class="comment">#src下的子目录，将被编译</span></span><br><span class="line">SUBDIRS = base matrix util feat tree gmm transform \</span><br><span class="line">          fstext hmm lm decoder lat kws cudamatrix nnet \</span><br><span class="line">          bin fstbin gmmbin fgmmbin featbin \</span><br><span class="line">          nnetbin latbin sgmm2 sgmm2bin nnet2 nnet3 rnnlm chain nnet3bin nnet2bin kwsbin \</span><br><span class="line">          ivector ivectorbin online2 online2bin lmbin chainbin rnnlmbin \</span><br><span class="line">	  cudadecoder cudadecoderbin</span><br><span class="line"></span><br><span class="line">MEMTESTDIRS = base matrix util feat tree gmm transform \</span><br><span class="line">          fstext hmm lm decoder lat nnet kws chain \</span><br><span class="line">          bin fstbin gmmbin fgmmbin featbin \</span><br><span class="line">          nnetbin latbin sgmm2 nnet2 nnet3 rnnlm nnet2bin nnet3bin sgmm2bin kwsbin \</span><br><span class="line">          ivector ivectorbin online2 online2bin lmbin</span><br><span class="line"></span><br><span class="line">CUDAMEMTESTDIR = cudamatrix</span><br><span class="line"><span class="comment">#过滤掉*bin目录</span></span><br><span class="line">SUBDIRS_LIB = $(filter-out %bin, $(SUBDIRS))</span><br><span class="line"><span class="comment">#如果KALDI_SONAME没有赋值，则赋值</span></span><br><span class="line">KALDI_SONAME ?= libkaldi.so</span><br><span class="line"></span><br><span class="line"><span class="comment"># Optional subdirectories</span></span><br><span class="line">EXT_SUBDIRS = online onlinebin  <span class="comment"># python-kaldi-decoding</span></span><br><span class="line"><span class="comment">#EXT_SUBDIRS_LIB = online</span></span><br><span class="line">EXT_SUBDIRS_LIB = $(filter-out %bin, $(EXT_SUBDIRS))</span><br><span class="line"><span class="comment">#生成gcc的配置，以及一些依赖的库的路径</span></span><br><span class="line">include kaldi.mk</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置Makefile的目标</span></span><br><span class="line"><span class="comment"># Reset the default goal, so that the all target will become default</span></span><br><span class="line">.DEFAULT_GOAL :=</span><br><span class="line">all: $(SUBDIRS) matrix/<span class="built_in">test</span></span><br><span class="line">	-<span class="built_in">echo</span> Done</span><br><span class="line"><span class="comment">#检查KALDLIBDIR是否存在</span></span><br><span class="line">mklibdir:</span><br><span class="line">	<span class="built_in">test</span> -d $(KALDILIBDIR) || mkdir $(KALDILIBDIR)</span><br><span class="line"></span><br><span class="line"><span class="comment">#I don't want to call rm -rf</span></span><br><span class="line">rmlibdir:</span><br><span class="line">ifneq ($(KALDILIBDIR), )</span><br><span class="line">	-rm $(KALDILIBDIR)/*&#123;.so,.a,.o&#125;</span><br><span class="line">	-rmdir $(KALDILIBDIR)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	@<span class="literal">true</span></span><br><span class="line">endif</span><br><span class="line"><span class="comment">#检查版本是否一致</span></span><br><span class="line">.PHONY: checkversion</span><br><span class="line">checkversion:</span><br><span class="line">ifeq ($(shell ./configure --version),$(CONFIGURE_VERSION))</span><br><span class="line">	@<span class="built_in">echo</span> <span class="string">"The version of configure script matches kaldi.mk version. Good."</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	@<span class="built_in">echo</span> <span class="string">""</span></span><br><span class="line">	@<span class="built_in">echo</span> <span class="string">"The kaldi.mk file was generated using a different version of configure script. Please rerun the configure again"</span></span><br><span class="line">	@<span class="built_in">test</span> -f ./kaldi.mk &amp;&amp; <span class="built_in">echo</span>  <span class="string">"Hint: Previous configure command line: "</span> &amp;&amp; head -n 2 ./kaldi.mk | grep configure | sed <span class="string">'s/^# *//g'</span></span><br><span class="line">	@<span class="built_in">echo</span> <span class="string">""</span></span><br><span class="line">	@<span class="literal">false</span></span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="comment">#检查kaldi.mk文件是否存在</span></span><br><span class="line">kaldi.mk:</span><br><span class="line">	@[ -f kaldi.mk ] || &#123; <span class="built_in">echo</span> <span class="string">"kaldi.mk does not exist; you have to run ./configure"</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Compile optional stuff</span></span><br><span class="line">ext: ext_depend $(SUBDIRS) $(EXT_SUBDIRS)</span><br><span class="line">	-<span class="built_in">echo</span> Done</span><br><span class="line"></span><br><span class="line">check_portaudio:</span><br><span class="line">	@[ -d ../tools/portaudio ] || ( <span class="built_in">cd</span> ../tools;  ./install_portaudio.sh )</span><br><span class="line"><span class="comment">#清理</span></span><br><span class="line">clean: rmlibdir</span><br><span class="line">	-<span class="keyword">for</span> x <span class="keyword">in</span> $(SUBDIRS) $(EXT_SUBDIRS); <span class="keyword">do</span> $(MAKE) -C $<span class="variable">$x</span> clean; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">distclean: clean</span><br><span class="line">	-<span class="keyword">for</span> x <span class="keyword">in</span> $(SUBDIRS) $(EXT_SUBDIRS); <span class="keyword">do</span> $(MAKE) -C $<span class="variable">$x</span> distclean; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#添加后缀 /test, 执行测试</span></span><br><span class="line"><span class="built_in">test</span>: $(addsuffix /<span class="built_in">test</span>, $(SUBDIRS_LIB))</span><br><span class="line"></span><br><span class="line">ext_test: $(addsuffix /<span class="built_in">test</span>, $(EXT_SUBDIRS_LIB))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Define an implicit rule, expands to e.g.:</span></span><br><span class="line"><span class="comment">#  base/test: base</span></span><br><span class="line"><span class="comment">#     $(MAKE) -C base test</span></span><br><span class="line">%/<span class="built_in">test</span>: % mklibdir</span><br><span class="line">	$(MAKE) -C $&lt; <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">cudavalgrind:</span><br><span class="line">	-<span class="keyword">for</span> x <span class="keyword">in</span> $(CUDAMEMTESTDIR); <span class="keyword">do</span> $(MAKE) -C $<span class="variable">$x</span> valgrind || &#123; <span class="built_in">echo</span> <span class="string">"valgrind on $<span class="variable">$x</span> failed"</span>; <span class="built_in">exit</span> 1; &#125;; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">valgrind:</span><br><span class="line">	-<span class="keyword">for</span> x <span class="keyword">in</span> $(MEMTESTDIRS); <span class="keyword">do</span> $(MAKE) -C $<span class="variable">$x</span> valgrind || &#123; <span class="built_in">echo</span> <span class="string">"valgrind on $<span class="variable">$x</span> failed"</span>; <span class="built_in">exit</span> 1; &#125;; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">base/.depend.mk:</span><br><span class="line">	$(MAKE) depend</span><br><span class="line"></span><br><span class="line">depend: $(addsuffix /depend, $(SUBDIRS))</span><br><span class="line"></span><br><span class="line"><span class="comment">#$(MAKE)就相当于make，-C 选项的作用是指将当前工作目录转移到你所指定的位置。</span></span><br><span class="line">%/depend:</span><br><span class="line">	$(MAKE) -C $(dir <span class="variable">$@</span>) depend</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ext_depend: check_portaudio</span><br><span class="line">	-<span class="keyword">for</span> x <span class="keyword">in</span> $(EXT_SUBDIRS); <span class="keyword">do</span> $(MAKE) -C $<span class="variable">$x</span> depend; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#这个伪目标会在子目录分别执行make</span></span><br><span class="line">.PHONY: $(SUBDIRS)</span><br><span class="line">$(SUBDIRS) : checkversion kaldi.mk mklibdir</span><br><span class="line">	$(MAKE) -C <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line">.PHONY: $(EXT_SUBDIRS)</span><br><span class="line">$(EXT_SUBDIRS) : checkversion kaldi.mk mklibdir ext_depend</span><br><span class="line">	$(MAKE) -C <span class="variable">$@</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>这个常用的五个目标如下：</p>
<ul>
<li>make depend: 重新生成依赖项。</li>
<li>make all：(跟直接执行make的结果一样)，编译所有需要编译的目录，包括测试代码。</li>
<li>make test：生成测试程序，执行测试代码</li>
<li>make clean：清理所有编译生成的文件，包括可执行文件，.o文件，.a文件等</li>
<li>make valgrind：将在valgrind下运行测试程序，以检查内存泄漏。 </li>
<li>make cudavalgrind: 运行测试程序(在cudamatrix中)，检查支持NVIDIA CUDA和CUDA安装的GPU卡机器的内存泄漏情况。</li>
</ul>
<p>从上述Makefile文件中可以看到make depend执行的动作，分别在SUBDIRS下执行make depend目录， 通过.DEFAULT_GOAL 重新定义此Makefile的目标，执行make后分别在SUBDIRS下执行make命令。</p>
<p>(2)src/kaldi.mk<br>这个Makefile是一个公共的Makefile文件，被其他Makefile文件包含，其中主要是设置编译器的选项(比如g++选项，链接器的选项，cuda的编译选项)和一些依赖的库（比如openfst, mkl）的路径。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This file was generated using the following command:</span></span><br><span class="line"><span class="comment"># ./configure --shared</span></span><br><span class="line"></span><br><span class="line">CONFIGURE_VERSION := 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># Toolchain configuration</span></span><br><span class="line"></span><br><span class="line">CXX = g++</span><br><span class="line">AR = ar</span><br><span class="line">AS = as</span><br><span class="line">RANLIB = ranlib</span><br><span class="line"></span><br><span class="line"><span class="comment"># Base configuration</span></span><br><span class="line"><span class="comment">#编译类型</span></span><br><span class="line">KALDI_FLAVOR := dynamic</span><br><span class="line"><span class="comment">#lib 目录，在这个目录建立软链接</span></span><br><span class="line">KALDILIBDIR := /home/cca01/luoxiaojie/luoxj/kaldi/src/lib</span><br><span class="line">DOUBLE_PRECISION = 0</span><br><span class="line"><span class="comment">#openfst include目录</span></span><br><span class="line">OPENFSTINC = /home/cca01/hdd190404/luoxj/kaldi/tools/openfst-1.6.7/include</span><br><span class="line"><span class="comment">#openfst 静态链接库</span></span><br><span class="line">OPENFSTLIBS = /home/cca01/hdd190404/luoxj/kaldi/tools/openfst-1.6.7/lib/libfst.so</span><br><span class="line"><span class="comment">#为程序添加一个运行时库文件搜索路径的命令，在使用gcc编译链接时添加即可。</span></span><br><span class="line">OPENFSTLDFLAGS = -Wl,-rpath=/home/cca01/hdd190404/luoxj/kaldi/tools/openfst-1.6.7/lib</span><br><span class="line"></span><br><span class="line">CUBROOT = /home/cca01/hdd190404/luoxj/kaldi/tools/cub-1.8.0</span><br><span class="line"><span class="comment">#mkl 根目录</span></span><br><span class="line">MKLROOT = /opt/intel/mkl</span><br><span class="line"><span class="comment">#mkl lib目录</span></span><br><span class="line">MKLLIB = /opt/intel/mkl/lib/intel64</span><br><span class="line"></span><br><span class="line"><span class="comment"># MKL specific Linux configuration</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># We have tested Kaldi with MKL version 10.2 on Linux/GCC and Intel(R) 64</span></span><br><span class="line"><span class="comment"># architecture (also referred to as x86_64) with LP64 interface layer.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#检查DOUBLE_PRECISIO， OPENFSTINC， OPENFSTLIBS， MKLROOT变量是否已经定义</span></span><br><span class="line">ifndef DOUBLE_PRECISIO</span><br><span class="line">$(error DOUBLE_PRECISION not defined.)</span><br><span class="line">endif</span><br><span class="line">ifndef OPENFSTINC</span><br><span class="line">$(error OPENFSTINC not defined.)</span><br><span class="line">endif</span><br><span class="line">ifndef OPENFSTLIBS</span><br><span class="line">$(error OPENFSTLIBS not defined.)</span><br><span class="line">endif</span><br><span class="line">ifndef MKLROOT</span><br><span class="line">$(error MKLROOT not defined.)</span><br><span class="line">endif</span><br><span class="line"><span class="comment">#MKLIB 如果没有赋值，则进行赋值</span></span><br><span class="line">MKLLIB ?= $(MKLROOT)/lib/intel64</span><br><span class="line"></span><br><span class="line"><span class="comment">#CXXFLAGS: C++ 编译器的选项。</span></span><br><span class="line"><span class="comment">#-std:指明C++版本</span></span><br><span class="line"><span class="comment">#-isystem: 指定一个系统目录</span></span><br><span class="line"><span class="comment">#-Wall：提示所有的warning</span></span><br><span class="line"><span class="comment">#-Wno-sign-compare 关闭当有符号转换为无符号时，有符号和无符号值比较产生的错误警告。</span></span><br><span class="line"><span class="comment">#-Wno-unused-local-typedefs: 忽略本地未使用的类型定义警告。</span></span><br><span class="line"><span class="comment">#-Wno-deprecated-declarations: 关闭使用废弃API的警告</span></span><br><span class="line"><span class="comment">#-Winit-self：关闭自己初始化自己的警告。 </span></span><br><span class="line"><span class="comment">#-msse, -msse2  让编译器使用cpu的sse， see2指令集</span></span><br><span class="line"><span class="comment">#-pthread: 多线程</span></span><br><span class="line"><span class="comment">#-g：生成操作系统调试信息</span></span><br><span class="line"><span class="comment">#-O0: 禁止编译器进行优化</span></span><br><span class="line">CXXFLAGS = -std=c++11 -I.. -isystem $(OPENFSTINC) -O1 $(EXTRA_CXXFLAGS) \</span><br><span class="line">           -Wall -Wno-sign-compare -Wno-unused-local-typedefs \</span><br><span class="line">           -Wno-deprecated-declarations -Winit-self \</span><br><span class="line">           -DKALDI_DOUBLEPRECISION=$(DOUBLE_PRECISION) \</span><br><span class="line">           -DHAVE_EXECINFO_H=1 -DHAVE_CXXABI_H -DHAVE_MKL -I$(MKLROOT)/include \</span><br><span class="line">           -m64 -msse -msse2 -pthread \</span><br><span class="line">           -g <span class="comment"># -O0 -DKALDI_PARANOID</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果是动态编译，加上-fPIC</span></span><br><span class="line">ifeq ($(KALDI_FLAVOR), dynamic)</span><br><span class="line">CXXFLAGS += -fPIC</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line"><span class="comment"># Compiler specific flags 标准错误重定向到标准输出</span></span><br><span class="line">COMPILER = $(shell $(CXX) -v 2&gt;&amp;1)</span><br><span class="line">ifeq ($(findstring clang,$(COMPILER)),clang)</span><br><span class="line"><span class="comment"># Suppress annoying clang warnings that are perfectly valid per spec.</span></span><br><span class="line">CXXFLAGS += -Wno-mismatched-tags</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line"><span class="comment">## Use the following for STATIC LINKING of the SEQUENTIAL version of MKL</span></span><br><span class="line">MKL_STA_SEQ = $(MKLLIB)/libmkl_solver_lp64_sequential.a -Wl,--start-group \</span><br><span class="line">	$(MKLLIB)/libmkl_intel_lp64.a $(MKLLIB)/libmkl_sequential.a \</span><br><span class="line">	$(MKLLIB)/libmkl_core.a -Wl,--end-group -lpthread</span><br><span class="line"></span><br><span class="line"><span class="comment">## Use the following for STATIC LINKING of the MULTI-THREADED version of MKL</span></span><br><span class="line">MKL_STA_MUL = $(MKLLIB)/libmkl_solver_lp64.a -Wl,--start-group \</span><br><span class="line">	$(MKLLIB)/libmkl_intel_lp64.a $(MKLLIB)/libmkl_intel_thread.a \</span><br><span class="line">	$(MKLLIB)/libmkl_core.a -Wl,--end-group $(MKLLIB)/libiomp5.a -lpthread</span><br><span class="line"></span><br><span class="line"><span class="comment">## Use the following for DYNAMIC LINKING of the SEQUENTIAL version of MKL</span></span><br><span class="line">MKL_DYN_SEQ = -L$(MKLLIB) -lmkl_solver_lp64_sequential -Wl,--start-group \</span><br><span class="line">	-lmkl_intel_lp64 -lmkl_sequential -lmkl_core -Wl,--end-group -lpthread</span><br><span class="line"></span><br><span class="line"><span class="comment">## Use the following for DYNAMIC LINKING of the MULTI-THREADED version of MKL</span></span><br><span class="line">MKL_DYN_MUL = -L$(MKLLIB) -lmkl_solver_lp64 -Wl,--start-group -lmkl_intel_lp64 \</span><br><span class="line">	-lmkl_intel_thread -lmkl_core -Wl,--end-group -liomp5 -lpthread</span><br><span class="line"></span><br><span class="line"><span class="comment"># MKLFLAGS = $(MKL_DYN_MUL)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#LDFLAGS:链接器的选项，也可以在里面指定库文件的位置</span></span><br><span class="line">LDFLAGS = $(EXTRA_LDFLAGS) $(OPENFSTLDFLAGS) -rdynamic</span><br><span class="line">LDLIBS = $(EXTRA_LDLIBS) $(OPENFSTLIBS) $(MKLFLAGS) -lm -lpthread -ldl</span><br><span class="line">MKLFLAGS = -L/opt/intel/mkl/lib/intel64 -Wl,-rpath=/opt/intel/mkl/lib/intel64 -lmkl_intel_lp64  -lmkl_core  -lmkl_sequential    -ldl -lpthread -lm </span><br><span class="line"></span><br><span class="line"><span class="comment"># CUDA configuration</span></span><br><span class="line"></span><br><span class="line">CUDA = <span class="literal">true</span></span><br><span class="line"><span class="comment">#cuda 目录</span></span><br><span class="line">CUDATKDIR = /usr/<span class="built_in">local</span>/cuda</span><br><span class="line">CUDA_ARCH = -gencode arch=compute_30,code=sm_30 -gencode arch=compute_35,code=sm_35 -gencode arch=compute_50,code=sm_50 -gencode arch=compute_52,code=sm_52 -gencode arch=compute_60,code=sm_60 -gencode arch=compute_61,code=sm_61</span><br><span class="line"></span><br><span class="line"><span class="comment">#检查DOUBLE_PRECISION，CUDATKDIR</span></span><br><span class="line">ifndef DOUBLE_PRECISION</span><br><span class="line">$(error DOUBLE_PRECISION not defined.)</span><br><span class="line">endif</span><br><span class="line">ifndef CUDATKDIR</span><br><span class="line">$(error CUDATKDIR not defined.)</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line"><span class="comment">#CXXFLAG </span></span><br><span class="line">CXXFLAGS += -DHAVE_CUDA -I$(CUDATKDIR)/include -fPIC -pthread -isystem $(OPENFSTINC)</span><br><span class="line"></span><br><span class="line">CUDA_INCLUDE= -I$(CUDATKDIR)/include -I$(CUBROOT)</span><br><span class="line">CUDA_FLAGS = --machine 64 -DHAVE_CUDA \</span><br><span class="line">             -ccbin $(CXX) -DKALDI_DOUBLEPRECISION=$(DOUBLE_PRECISION) \</span><br><span class="line">             -std=c++11 -DCUDA_API_PER_THREAD_DEFAULT_STREAM  -lineinfo \</span><br><span class="line">             --verbose -Xcompiler <span class="string">"<span class="variable">$(CXXFLAGS)</span>"</span></span><br><span class="line"></span><br><span class="line">CUDA_LDFLAGS += -L$(CUDATKDIR)/lib64 -Wl,-rpath,$(CUDATKDIR)/lib64</span><br><span class="line">CUDA_LDLIBS += -lcublas -lcusparse -lcudart -lcurand -lnvToolsExt <span class="comment">#LDLIBS : The .so libs are loaded later than static libs in implicit rule</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Environment configuration</span></span><br></pre></td></tr></table></figure></p>
<p>(3)src/${subdir}/Makefile<br>这里以featbin中的Makefile为例。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">all:</span><br><span class="line">EXTRA_CXXFLAGS = -Wno-sign-compare</span><br><span class="line">include ../kaldi.mk</span><br><span class="line"></span><br><span class="line">BINFILES = add-deltas add-deltas-sdc append-post-to-feats \</span><br><span class="line">           append-vector-to-feats apply-cmvn apply-cmvn-sliding compare-feats \</span><br><span class="line">           compose-transforms compute-and-process-kaldi-pitch-feats \</span><br><span class="line">           compute-cmvn-stats compute-cmvn-stats-two-channel \</span><br><span class="line">           compute-fbank-feats compute-kaldi-pitch-feats compute-mfcc-feats \</span><br><span class="line">           compute-plp-feats compute-spectrogram-feats concat-feats copy-feats \</span><br><span class="line">           copy-feats-to-htk copy-feats-to-sphinx extend-transform-dim \</span><br><span class="line">           extract-feature-segments extract-segments feat-to-dim \</span><br><span class="line">           feat-to-len fmpe-acc-stats fmpe-apply-transform fmpe-est \</span><br><span class="line">           fmpe-init fmpe-sum-accs get-full-lda-mat interpolate-pitch \</span><br><span class="line">           modify-cmvn-stats paste-feats post-to-feats \</span><br><span class="line">           process-kaldi-pitch-feats process-pitch-feats \</span><br><span class="line">           select-feats <span class="built_in">shift</span>-feats splice-feats subsample-feats \</span><br><span class="line">           subset-feats transform-feats wav-copy wav-reverberate \</span><br><span class="line">           wav-to-duration</span><br><span class="line"></span><br><span class="line">OBJFILES =</span><br><span class="line"></span><br><span class="line">TESTFILES =</span><br><span class="line"></span><br><span class="line">ADDLIBS = ../hmm/kaldi-hmm.a ../feat/kaldi-feat.a \</span><br><span class="line">          ../transform/kaldi-transform.a ../gmm/kaldi-gmm.a \</span><br><span class="line">          ../tree/kaldi-tree.a ../util/kaldi-util.a ../matrix/kaldi-matrix.a \</span><br><span class="line">          ../base/kaldi-base.a </span><br><span class="line"></span><br><span class="line">include ../makefiles/default_rules.mk</span><br></pre></td></tr></table></figure></p>
<p>可以看到，这个Makefile中包含src/kaldi.mk和src/makefiles/default_rules.mk这两个文件，同时定义了几个变量，主要有五个变量，根据需要选择定义其中的变量。kaldi_rules.mk将根据这些变量生成对应的文件。下面解释这些变量的的作用。</p>
<ul>
<li>BINFILES: 需要生成的可执行文件，对于以bin结果的子目录会定义这个变量</li>
<li>OBJFILES: 需要生成的.o文件</li>
<li>TESTFILES: 需要生成的测试文件</li>
<li>ADDLIBS: 依赖的库文件</li>
<li>LIBNAME: 生成的库的名称，如果定义了这个变量，则会根据这里LIBNAME生成的对应的动态链接库。</li>
</ul>
<p>（4）src/makefiles/default_rules.mk<br>这个Makefile是真正执行编译的Makefile文件，同时也是个公共的Makefile文件。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">SHELL := /bin/bash</span><br><span class="line"></span><br><span class="line">ifeq ($(KALDI_FLAVOR), dynamic)</span><br><span class="line">  ifeq ($(shell uname), Darwin)</span><br><span class="line">    ifdef LIBNAME</span><br><span class="line">      LIBFILE = lib$(LIBNAME).dylib</span><br><span class="line">    endif</span><br><span class="line">    LDFLAGS += -Wl,-rpath -Wl,$(KALDILIBDIR)</span><br><span class="line">    EXTRA_LDLIBS += $(foreach dep,$(ADDLIBS), $(dir $(dep))lib$(notdir $(basename $(dep))).dylib)</span><br><span class="line">  <span class="keyword">else</span> ifeq ($(shell uname), Linux)</span><br><span class="line">    ifdef LIBNAME</span><br><span class="line">      LIBFILE = lib$(LIBNAME).so</span><br><span class="line">    endif</span><br><span class="line">    LDFLAGS += -Wl,-rpath=$(shell readlink -f $(KALDILIBDIR))</span><br><span class="line">    EXTRA_LDLIBS += $(foreach dep,$(ADDLIBS), $(dir $(dep))lib$(notdir $(basename $(dep))).so)</span><br><span class="line">  <span class="keyword">else</span>  <span class="comment"># Platform not supported</span></span><br><span class="line">    $(error Dynamic libraries not supported on this platform. Run configure with --static flag.)</span><br><span class="line">  endif</span><br><span class="line">  XDEPENDS =</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  ifdef LIBNAME</span><br><span class="line">    LIBFILE = $(LIBNAME).a</span><br><span class="line">  endif</span><br><span class="line">  XDEPENDS = $(ADDLIBS)</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">all: $(LIBFILE) $(BINFILES)</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果定义了LIBNAME</span></span><br><span class="line">ifdef LIBNAME</span><br><span class="line"><span class="comment">#ar 创建静态库.a文件</span></span><br><span class="line"><span class="comment">#ranlib 更新静态库的符号索引表 </span></span><br><span class="line"><span class="comment">#这里会依赖.o文件，会根据.depend.mk中的依赖，根据Makefile的隐含规则创建对应的目标文件</span></span><br><span class="line">$(LIBNAME).a: $(OBJFILES)</span><br><span class="line">	$(AR) -cr $(LIBNAME).a $(OBJFILES)</span><br><span class="line">	$(RANLIB) $(LIBNAME).a</span><br><span class="line"></span><br><span class="line">ifeq ($(KALDI_FLAVOR), dynamic)</span><br><span class="line"><span class="comment"># the LIBFILE is not the same as $(LIBNAME).a</span></span><br><span class="line">$(LIBFILE): $(LIBNAME).a</span><br><span class="line">  ifeq ($(shell uname), Darwin)</span><br><span class="line">	$(CXX) -dynamiclib -o <span class="variable">$@</span> -install_name @rpath/<span class="variable">$@</span> $(LDFLAGS) $(OBJFILES) $(LDLIBS)</span><br><span class="line">	ln -sf $(shell <span class="built_in">pwd</span>)/<span class="variable">$@</span> $(KALDILIBDIR)/<span class="variable">$@</span></span><br><span class="line">  <span class="keyword">else</span> ifeq ($(shell uname), Linux)</span><br><span class="line">        <span class="comment"># Building shared library from static (static was compiled with -fPIC)</span></span><br><span class="line">	$(CXX) -shared -o <span class="variable">$@</span> -Wl,--no-undefined -Wl,--as-needed  -Wl,-soname=<span class="variable">$@</span>,--whole-archive $(LIBNAME).a -Wl,--no-whole-archive $(LDFLAGS) $(LDLIBS)</span><br><span class="line">	ln -sf $(shell <span class="built_in">pwd</span>)/<span class="variable">$@</span> $(KALDILIBDIR)/<span class="variable">$@</span></span><br><span class="line">  <span class="keyword">else</span>  <span class="comment"># Platform not supported</span></span><br><span class="line">	$(error Dynamic libraries not supported on this platform. Run configure with --static flag.)</span><br><span class="line">  endif</span><br><span class="line">endif <span class="comment"># ifeq ($(KALDI_FLAVOR), dynamic)</span></span><br><span class="line">endif <span class="comment"># ifdef LIBNAME</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># By default (GNU) make uses the C compiler $(CC) for linking object files even</span></span><br><span class="line"><span class="comment"># if they were compiled from a C++ source. Below redefinition forces make to</span></span><br><span class="line"><span class="comment"># use the C++ compiler $(CXX) instead.</span></span><br><span class="line"><span class="comment">#把.o文件链接在一起的命令行，缺省值是$(CC) $(LDFLAGS) $(TARGET_ARCH)</span></span><br><span class="line">LINK.o = $(CXX) $(LDFLAGS) $(TARGET_ARCH)</span><br><span class="line"><span class="comment">#make最终的目标， 这里根据Makefile的隐含规则创建可执行文件</span></span><br><span class="line">$(BINFILES): $(LIBFILE) $(XDEPENDS)</span><br><span class="line"></span><br><span class="line"><span class="comment"># When building under CI, CI_NOLINKBINARIES is set to skip linking of binaries.</span></span><br><span class="line">ifdef CI_NOLINKBINARIES</span><br><span class="line">$(BINFILES): %: %.o</span><br><span class="line">	touch <span class="variable">$@</span></span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line"><span class="comment"># Rule below would expand to, e.g.:</span></span><br><span class="line"><span class="comment"># ../base/kaldi-base.a:</span></span><br><span class="line"><span class="comment"># 	make -C ../base kaldi-base.a</span></span><br><span class="line"><span class="comment"># -C option to make is same as changing directory.</span></span><br><span class="line">%.a:</span><br><span class="line">	$(MAKE) -C <span class="variable">$&#123;@D&#125;</span> <span class="variable">$&#123;@F&#125;</span></span><br><span class="line"></span><br><span class="line">%.so:</span><br><span class="line">	$(MAKE) -C <span class="variable">$&#123;@D&#125;</span> <span class="variable">$&#123;@F&#125;</span></span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">	-rm -f *.o *.a *.so $(TESTFILES) $(BINFILES) $(TESTOUTPUTS) tmp* *.tmp *.testlog</span><br><span class="line"></span><br><span class="line">distclean: clean</span><br><span class="line">	-rm -f .depend.mk</span><br><span class="line"></span><br><span class="line">$(TESTFILES): $(LIBFILE) $(XDEPENDS)</span><br><span class="line"></span><br><span class="line">test_compile: $(TESTFILES)</span><br><span class="line"><span class="comment">#编译测试文件，并执行</span></span><br><span class="line"><span class="built_in">test</span>: test_compile</span><br><span class="line">	@&#123; result=0;			\</span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> $(TESTFILES); <span class="keyword">do</span>	\</span><br><span class="line">	  <span class="built_in">printf</span> <span class="string">"Running $<span class="variable">$x</span> ..."</span>;	\</span><br><span class="line">      timestamp1=$$(date +<span class="string">"%s"</span>); \</span><br><span class="line">	  ./$<span class="variable">$x</span> &gt;$<span class="variable">$x</span>.testlog 2&gt;&amp;1;	\</span><br><span class="line">      ret=$$? \</span><br><span class="line">      timestamp2=$$(date +<span class="string">"%s"</span>); \</span><br><span class="line">      time_taken=$$[timestamp2-timestamp1]; \</span><br><span class="line">	  <span class="keyword">if</span> [ $<span class="variable">$ret</span> -ne 0 ]; <span class="keyword">then</span> \</span><br><span class="line">	    <span class="built_in">echo</span> <span class="string">" $<span class="variable">$&#123;time_taken&#125;</span>s... FAIL $<span class="variable">$x</span>"</span>; \</span><br><span class="line">	    result=1;			\</span><br><span class="line">	    <span class="keyword">if</span> [ -n <span class="string">"<span class="variable">$TRAVIS</span>"</span> ] &amp;&amp; [ -f core ] &amp;&amp; <span class="built_in">command</span> -v gdb &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span>	\</span><br><span class="line">	      gdb $<span class="variable">$x</span> core -ex <span class="string">"thread apply all bt"</span> -batch &gt;&gt;$<span class="variable">$x</span>.testlog 2&gt;&amp;1;		\</span><br><span class="line">	      rm -rf core;		\</span><br><span class="line">	    <span class="keyword">fi</span>;				\</span><br><span class="line">	  <span class="keyword">else</span>				\</span><br><span class="line">	    <span class="built_in">echo</span> <span class="string">" $<span class="variable">$&#123;time_taken&#125;</span>s... SUCCESS $<span class="variable">$x</span>"</span>;		\</span><br><span class="line">	    rm -f $<span class="variable">$x</span>.testlog;		\</span><br><span class="line">	  <span class="keyword">fi</span>;				\</span><br><span class="line">	<span class="keyword">done</span>;				\</span><br><span class="line">	<span class="built_in">exit</span> $<span class="variable">$result</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Rules that enable valgrind debugging ("make valgrind")</span></span><br><span class="line"></span><br><span class="line">valgrind: .valgrind</span><br><span class="line"></span><br><span class="line">.valgrind: $(TESTFILES)</span><br><span class="line">	<span class="built_in">echo</span> -n &gt; valgrind.out</span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> $(TESTFILES); <span class="keyword">do</span> \</span><br><span class="line">		<span class="built_in">echo</span> $<span class="variable">$x</span> &gt;&gt;valgrind.out; \</span><br><span class="line">		valgrind ./$<span class="variable">$x</span> &gt;/dev/null 2&gt;&gt; valgrind.out; \</span><br><span class="line">	<span class="keyword">done</span></span><br><span class="line">	! ( grep <span class="string">'ERROR SUMMARY'</span> valgrind.out | grep -v <span class="string">'0 errors'</span> )</span><br><span class="line">	! ( grep <span class="string">'definitely lost'</span> valgrind.out | grep -v -w 0 )</span><br><span class="line">	rm valgrind.out</span><br><span class="line">	touch .valgrind</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#buid up dependency commands</span></span><br><span class="line">CC_SRCS=$(wildcard *.cc)</span><br><span class="line"><span class="comment">#check if files exist to run dependency commands on</span></span><br><span class="line">ifneq ($(CC_SRCS),)</span><br><span class="line">CC_DEP_COMMAND=$(CXX) -M $(CXXFLAGS) $(CC_SRCS)</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line"><span class="comment">#kaldi.mk中定义了CUDA=true</span></span><br><span class="line">ifeq ($(CUDA), <span class="literal">true</span>)</span><br><span class="line"><span class="comment">#统配符*.cu文件</span></span><br><span class="line">CUDA_SRCS=$(wildcard *.cu)</span><br><span class="line"><span class="comment">#check if files exist to run dependency commands on</span></span><br><span class="line">ifneq ($(CUDA_SRCS),)</span><br><span class="line">NVCC_DEP_COMMAND = $(CUDATKDIR)/bin/nvcc -M $(CUDA_FLAGS) $(CUDA_INCLUDE) $(CUDA_SRCS)</span><br><span class="line">endif</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line">depend:</span><br><span class="line">	rm -f .depend.mk</span><br><span class="line">ifneq ($(CC_DEP_COMMAND),)</span><br><span class="line">	<span class="comment">#生成.depend.mk 文件</span></span><br><span class="line">	$(CC_DEP_COMMAND) &gt;&gt; .depend.mk</span><br><span class="line">endif</span><br><span class="line">ifneq ($(NVCC_DEP_COMMAND),)</span><br><span class="line">	$(NVCC_DEP_COMMAND) &gt;&gt; .depend.mk</span><br><span class="line">endif</span><br><span class="line"></span><br><span class="line"><span class="comment"># removing automatic making of "depend" as it's quite slow.</span></span><br><span class="line"><span class="comment">#.depend.mk: depend</span></span><br><span class="line">-include .depend.mk</span><br></pre></td></tr></table></figure></p>
<p>这个Makefile可以说是最重要的Makefile，所有的Makefile的最终目标都是通过这个Makefiel生成，包括生成depend，测试，编译，清理这些动作，都是在这里完成，当执行depend目标时，先列出当前目录的所有.cc文件，然后通过CC_DEP_COMMAND命令生成.depend.mk文件。当执行make时，将会根据上一个文件定义的变量执行响应的逻辑生成响应的文件，其中需要注意的是生成可执行文件时，并没有显示的命令用于生成相应的文件，因为这里利用的Makefile的隐含规则，当没有显式的如何生成可执行文件时，会在寻找目录和文件中定义的同名的.o文件生成对应的可执行文件，如果没有找不到，就会报错。<br>可以通过make -p查看make执行过程中查找隐含规则的过程。</p>
<p>(5)src/${subdir}/.depend.mk<br>这个文件主要包括目标的依赖。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">feature-sdc-test.o: feature-sdc-test.cc /usr/include/stdc-predef.h \</span><br><span class="line"> /usr/include/c++/5/iostream \</span><br><span class="line"> /usr/include/x86_64-linux-gnu/c++/5/bits/c++config.h \</span><br><span class="line"> /usr/include/x86_64-linux-gnu/c++/5/bits/os_defines.h \</span><br><span class="line"> /usr/include/features.h /usr/include/x86_64-linux-gnu/sys/cdefs.h \</span><br><span class="line"> /usr/include/x86_64-linux-gnu/bits/wordsize.h \</span><br><span class="line"> /usr/include/x86_64-linux-gnu/gnu/stubs.h \</span><br><span class="line"> /usr/include/x86_64-linux-gnu/gnu/stubs-64.h \</span><br><span class="line"> /usr/include/x86_64-linux-gnu/c++/5/bits/cpu_defines.h \</span><br><span class="line"> /usr/include/c++/5/ostream /usr/include/c++/5/ios \</span><br><span class="line"> /usr/include/c++/5/iosfwd /usr/include/c++/5/bits/stringfwd.h \</span><br><span class="line"> /usr/include/c++/5/bits/memoryfwd.h /usr/include/c++/5/bits/postypes.h \</span><br><span class="line"> /usr/include/c++/5/cwchar /usr/include/wchar.h /usr/include/stdio.h \</span><br><span class="line"> ...</span><br><span class="line"> signal-test.o: signal-test.cc /usr/include/stdc-predef.h \</span><br><span class="line"> ../base/kaldi-common.h /usr/include/c++/5/cstddef \</span><br><span class="line"> /usr/include/x86_64-linux-gnu/c++/5/bits/c++config.h \</span><br><span class="line"> /usr/include/x86_64-linux-gnu/c++/5/bits/os_defines.h \</span><br><span class="line"> /usr/include/features.h /usr/include/x86_64-linux-gnu/sys/cdefs.h \</span><br><span class="line"> /usr/include/x86_64-linux-gnu/bits/wordsize.h \</span><br><span class="line"> /usr/include/x86_64-linux-gnu/gnu/stubs.h \</span><br><span class="line"> /usr/include/x86_64-linux-gnu/gnu/stubs-64.h \</span><br><span class="line"> /usr/include/x86_64-linux-gnu/c++/5/bits/cpu_defines.h \</span><br><span class="line"> /usr/lib/gcc/x86_64-linux-gnu/5/include/stddef.h \</span><br><span class="line"> /usr/include/c++/5/cstdlib /usr/include/stdlib.h \</span><br><span class="line"> ...</span><br></pre></td></tr></table></figure></p>
<p>以上便是kald的src目录的编译过程。</p>
</div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>追风的猪</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2019/05/17/Kaldi的编译过程-makefile/">http://joefi.github.io/2019/05/17/Kaldi的编译过程-makefile/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0 CN</a> 许可协议。转载请注明出处！</li></ul></div><br><div class="tags"><a href="/tags/kaldi/">kaldi</a></div><div class="post-nav"><a class="pre" href="/2019/05/18/Kaldi中的nnet3/">Kaldi中的nnet3</a><a class="next" href="/2019/05/17/阅读和修改kaldi的代码/">阅读和修改kaldi的代码</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == true ? true : false;
var verify = 'false' == true ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'EpW4PIfxM4lnev23BejpJKx7-gzGzoHsz',
  appKey:'2rvFbqd5gcnWYpcGVjVvNRcn',
  placeholder:'Just so so',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://joefi.github.io"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/kaldi/">kaldi</a><span class="category-list-count">2</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/kaldi-debug/" style="font-size: 15px;">kaldi debug</a> <a href="/tags/kaldi/" style="font-size: 15px;">kaldi</a> <a href="/tags/kaldi-nnet3/" style="font-size: 15px;">kaldi nnet3</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/05/18/Kaldi中的nnet3/">Kaldi中的nnet3</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/17/Kaldi的编译过程-makefile/">Kaldi的编译过程-makefile</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/17/阅读和修改kaldi的代码/">阅读和修改kaldi的代码</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">追风的猪.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>